function vgseGetSelectedIds(){var e=hot.getDataAtCol(0),a=[];return e.forEach(function(e,t){e&&a.push(hot.getDataAtRowProp(t,"ID"))}),a}function vgseAddField(e,t){return e.append('<div class="vg-field"><'+t.tag+" /></div>"),$field=e.find(".vg-field").last(),"select"===t.tag&&t.options&&$field.find(t.tag).append(t.options),$field.find(t.tag).attr(t.html_attrs),t.label&&"a"!==t.tag&&$field.prepend("<label>"+t.label+"</label>"),t.label&&"a"===t.tag&&$field.find(t.tag).text(t.label),t.description&&$field.append("<p>"+t.description+"</p>"),"a"===t.tag&&$field.append('<input type="hidden" />'),$field}function vgseGenerateMathFormula(e){return!!e.firstFieldValue&&'=MATH("'+e.firstFieldValue+'")'}function vgseGenerateDecreasePercentageFormula(e){return!!e.firstFieldValue&&'=MATH("$current_value$ * 0.'+("0"+(100-parseFloat(e.firstFieldValue))).slice(-2)+'")'}function vgseGenerateIncreasePercentageFormula(e){return!!e.firstFieldValue&&'=MATH("$current_value$ * 1.'+("0"+e.firstFieldValue).slice(-2)+'")'}function vgseGenerateDecreaseFormula(e){return!!e.firstFieldValue&&'=MATH("$current_value$ - '+e.firstFieldValue+'")'}function vgseGenerateIncreaseFormula(e){return!!e.firstFieldValue&&'=MATH("$current_value$ + '+e.firstFieldValue+'")'}function vgseGenerateSetValueFormula(e){if(e.actionSettings.fields_relationship||(e.actionSettings.fields_relationship="AND"),"or"===e.actionSettings.fields_relationship.toLowerCase()&&1<e.actionFields.length){var t="";e.actionFields.each(function(){jQuery(this).val()&&(t=jQuery(this).val())}),e.firstFieldValue=t}return!!e.firstFieldValue&&'=REPLACE(""$current_value$"",""'+e.firstFieldValue+'"")'}function vgseGenerateAppendFormula(e){if(e.actionSettings.fields_relationship||(e.actionSettings.fields_relationship="AND"),"or"===e.actionSettings.fields_relationship.toLowerCase()&&1<e.actionFields.length){var t="";e.actionFields.each(function(){jQuery(this).val()&&(t=jQuery(this).val())}),e.firstFieldValue=t}if(!e.firstFieldValue)return!1;var a=jQuery(".column-selector select"),r="";return"post_terms"!==a.find("option:selected").data("value-type")&&"boton_gallery_multiple"!==a.find("option:selected").data("value-type")||(r=vgse_editor_settings.taxonomy_terms_separator),'=REPLACE(""$current_value$"",""$current_value$'+r+e.firstFieldValue+'"")'}function vgseGenerateClearValueFormula(e){return'=REPLACE(""$current_value$"","""")'}function vgseGenerateCapitalizeWordsFormula(e){return'=REPLACE(""$current_value$"",""$current_value_capitalize_each_word$"")'}function vgseGenerateCustomFormula(e){return!!e.firstFieldValue&&(e.firstFieldValue.indexOf("=REPLACE")<0&&e.firstFieldValue.indexOf("=MATH")<0?(alert(vgse_formulas_data.texts.wrong_formula),""):e.firstFieldValue)}function vgseGeneratePrependFormula(e){if(e.actionSettings.fields_relationship||(e.actionSettings.fields_relationship="AND"),"or"===e.actionSettings.fields_relationship.toLowerCase()&&1<e.actionFields.length){var t="";e.actionFields.each(function(){jQuery(this).val()&&(t=jQuery(this).val())}),e.firstFieldValue=t}if(!e.firstFieldValue)return!1;var a=jQuery(".column-selector select"),r="";return"post_terms"!==a.find("option:selected").data("value-type")&&"boton_gallery_multiple"!==a.find("option:selected").data("value-type")||(r=vgse_editor_settings.taxonomy_terms_separator),'=REPLACE(""$current_value$"",""'+e.firstFieldValue+r+'$current_value$"")'}function vgseGenerateReplaceFormula(e){"post_terms"===jQuery(".column-selector select").find("option:selected").data("value-type")&&(e.actionFields=e.actionFields.filter("select"));var t=[];return e.actionFields.each(function(){var e=jQuery(this).val()||"";t.push('""'+e+'""')}),!(t.length<2)&&"=REPLACE("+t.join(",")+")"}function vgseGenerateMergeFormula(e){var t="";return e.actionFields.each(function(){var e=jQuery(this).val();e&&!t&&(t=e)}),!!t&&'=REPLACE(""$current_value$"",""'+t+'"")'}jQuery(document).ready(function(){var m=jQuery(".modal-formula form"),v=jQuery(".vgse-execute-formula"),_=m.find(".formula-field textarea");m.find(".wpse-formula-post-query").click(function(e){e.preventDefault(),window.vgseBackToFormula=!0,jQuery('[name="run_filters"]').first().click()}),m.find(".wpse-select-rows-options").change(function(e){"new_search"===jQuery(this).val()?(window.vgseBackToFormula=!0,jQuery('[name="run_filters"]').first().click(),m.find(".wpse-formula-post-query").show()):m.find(".wpse-formula-post-query").hide()}),m.find(".wpse-select-rows-options").trigger("change"),jQuery(document).on("closed",'[data-remodal-id="modal-filters"]',function(){void 0!==window.vgseBackToFormula&&window.vgseBackToFormula&&(window.vgseBackToFormula=!1,jQuery('[data-remodal-target="modal-formula"]').first().click())}),jQuery(document).on("closing",'[data-remodal-id="modal-formula"]',function(){var e=jQuery(".modal-formula .go-back-formula-execution");e.is(":visible")&&e.first().click()}),m.find(".multiple-column-selector > select").change(function(e){var t=jQuery(this).val(),a=m.find(".column-selector select"),r=!1;t&&"object"==typeof t&&t.forEach(function(e){if(e&&!r)return r=e,!0}),r?a.val(r):a.val(""),a.trigger("change")}),jQuery(".modal-formula form").submit(function(){if(!m.find(".wpse-select-rows-options").val())return!1;var e=window.beFoundRows;if("selected"===m.find(".wpse-select-rows-options").val()){var t=vgseGetSelectedIds();if(e=t.length){var o=beGetRowsFilters();beAddRowsFilter("post__in="+t.join(","))}}if(!e)return alert(vgse_editor_settings.texts.no_rows_for_formula),!1;if(beGetModifiedItems().length&&!confirm(vgse_editor_settings.texts.save_changes_before_we_reload))return!1;if("function"==typeof beGetRowsFilters&&m.find('input[name="filters_found_rows"]').val(e),!_.val())return alert(vgse_formulas_data.texts.formula_required),!1;m.hide(),v.show();var a=m.find('[name="nonce"]').val(),l=m.find('[name="filters_found_rows"]').val(),r=_.val(),s=m.find('[name="post_type"]').val(),i=jQuery(".be-response");v.find(".speed-tip").hide(),v.find(".edit-running").show(),v.find(".pause-formula-execution").show(),v.find("#be-formulas-nanobar-container").remove(),i.before('<div id="be-formulas-nanobar-container" />');var n={classname:"be-progress-bar",target:document.getElementById("be-formulas-nanobar-container")},d=0,u=m.find(".multiple-column-selector > select option:selected"),c=[];u.each(function(){jQuery(this).val()&&c.push({label:jQuery(this).text(),key:jQuery(this).val()})});c[0].key;1<c.length?i.addClass("multiple-edits"):i.addClass("single-edit");var f=new Nanobar(n);f.go(1),v.find(".remodal-cancel").hide();var p={total:0,processed:0,updated:0};return window.beFormulaLoop=beAjaxLoop({totalCalls:Math.ceil(l/vgse_editor_settings.save_posts_per_page),url:ajaxurl,dataType:"json",method:"POST",data:{action:"vgse_bulk_edit_formula_big",total:l,column:c[d].key,apply_to:"all",formula:r,nonce:a,post_type:s,filters:beGetRowsFilters(),raw_form_data:m.serialize(),wpse_source_suffix:vgse_editor_settings.wpse_source_suffix||""},onSuccess:function(e,t){if(!e.success)return i.append("<p>"+e.data.message+"</p>"),i.scrollTop(i[0].scrollHeight),f.go(100),v.find(".remodal-cancel").show(),!1;p.processed+=e.data.processed,p.updated+=e.data.updated,p.total||(p.total+=e.data.total);var a=e.data.force_complete?100:parseInt(t.current/t.totalCalls*100);if(e.data.message=e.data.message.replace("{total}",p.total),e.data.message=e.data.message.replace("{progress_percentage}",a),e.data.message=e.data.message.replace("{edited}",p.updated),e.data.message=e.data.message.replace("{column_label}",c[d].label),"delete"!==m.find(".formula-parameter-field").val()&&(t.totalCalls=Math.ceil(parseInt(e.data.total)/vgse_editor_settings.save_posts_per_page)),i.find(".success-message"+t.data.column).remove(),i.find(".complete-message").remove(),i.append(e.data.message),i.scrollTop(i[0].scrollHeight),e.data.force_complete){if(1<c.length&&d<c.length-1)return d++,t.data.column=c[d].key,t.current=0,t.totalCalls=Math.ceil(l/vgse_editor_settings.save_posts_per_page),f.go(1),p.processed=p.updated=p.total=0,!0;var r=vgse_editor_settings.texts.formula_execution_complete;return vgse_editor_settings.texts.ask_review&&(r+="<br>"+vgse_editor_settings.texts.ask_review),i.append(r),v.find(".edit-running").hide(),v.find(".pause-formula-execution").hide(),f.go(100),v.find(".remodal-cancel").show(),void 0!==o&&beAddRowsFilter("post__in="),vgseReloadSpreadsheet(),!1}if(t.current!==t.totalCalls)return v.find(".speed-tip").show(),f.go(a),v.find(".remodal-cancel").hide(),!0;if(1<c.length&&d<c.length-1)return d++,t.data.column=c[d].key,t.current=0,t.totalCalls=Math.ceil(l/vgse_editor_settings.save_posts_per_page),f.go(1),p.processed=p.updated=p.total=0,!0;v.find(".edit-running").hide(),v.find(".pause-formula-execution").hide();r=vgse_editor_settings.texts.formula_execution_complete;return vgse_editor_settings.texts.ask_review&&(r+="<br>"+vgse_editor_settings.texts.ask_review),i.append(r),i.scrollTop(i[0].scrollHeight),f.go(100),v.find(".remodal-cancel").show(),void 0!==o&&beAddRowsFilter("post__in="),vgseReloadSpreadsheet(),!1},onError:function(e,t,a){return confirm(vgse_editor_settings.texts.formula_retry_batch)?(window.vgseDontNotifyServerError=!0,a.current--,f.go(a.current/a.totalCalls*100),v.find(".remodal-cancel").hide(),!0):(i.append(vgse_editor_settings.texts.formula_execution_failed),i.scrollTop(i[0].scrollHeight),f.go(100),v.find(".remodal-cancel").show(),!1)}}),jQuery(".pause-formula-execution").data("action","pause").addClass("button-secondary").removeClass("button-primary").html('<i class="fa fa-pause"></i> Pause'),v.find(".be-response").empty(),!1}),jQuery(".pause-formula-execution").click(function(e){e.preventDefault();var t=jQuery(this);"pause"===t.data("action")?(t.data("action","play").addClass("button-primary").removeClass("button-secondary").html('<i class="fa fa-play"></i> Resume'),window.beFormulaLoop.pause()):(t.data("action","pause").addClass("button-secondary").removeClass("button-primary").html('<i class="fa fa-pause"></i> Pause'),window.beFormulaLoop.resume())}),jQuery(".go-back-formula-execution").click(function(e){e.preventDefault(),m.show(),v.hide(),jQuery(".pause-formula-execution").data("action","play").addClass("button-primary").removeClass("button-secondary").html('<i class="fa fa-play"></i> Resume'),window.beFormulaLoop.pause()});var e=jQuery(".formula-builder"),n=jQuery(".column-selector select"),l=vgseAddField(e,{tag:"select",label:vgse_formulas_data.texts.action_select_label,html_attrs:{name:"action_name",class:"action_name",id:"action_name"},options:'<option value="" class="placeholder">'+vgse_formulas_data.texts.action_select_placeholder+"</option>"});e.append('<div class="builder-fields"></div>');var d=e.find(".builder-fields");jQuery.each(vgse_formulas_data.columns_actions,function(e,t){if("default"===t)t=vgse_formulas_data.default_actions;else{var a={};jQuery.each(t,function(e,t){t="default"===t?vgse_formulas_data.default_actions[e]:jQuery.extend({},vgse_formulas_data.default_actions[e],t),a[e]=t}),t=a}vgse_formulas_data.columns_actions[e]=t}),n.change(function(e){var t=jQuery(this),a=t.val(),r=t.find("option:selected").data("value-type"),o=vgse_editor_settings.final_spreadsheet_columns_settings[a];columnFields=vgse_formulas_data.columns_actions[r],columnFields||(n.find("option:selected").data("value-type","text"),columnFields=vgse_formulas_data.columns_actions.text),l.find("select option:not(.placeholder)").remove(),d.empty(),jQuery.each(columnFields,function(e,t){if(o&&o.supported_formula_types&&o.supported_formula_types.length&&o.supported_formula_types.indexOf(e)<0)return!0;(void 0===t.allowed_column_keys||!t.allowed_column_keys||-1<t.allowed_column_keys.indexOf(a))&&l.find("select").append('<option value="'+e+'">'+t.label+"</option>")})}),l.find("select").change(function(e){var t=jQuery(this).val();if(!t)return!0;var a=n.find("option:selected").data("value-type"),r=vgse_formulas_data.columns_actions[a][t],o=r.input_fields;d.empty(),r.description&&(r.description=r.description.replace("%target_column%",n.val()),d.append('<p class="action-description">'+r.description+"</p>")),d.append('<div class="action-fields"></div>');var l=d.find(".action-fields"),s={tag:"",label:"",description:"",html_attrs:{class:"formula-parameter-field"}};jQuery.each(o,function(e,t){t=jQuery.extend(s,t),r.fields_relationship||(r.fields_relationship="AND"),void 0!==t.html_attrs&&void 0!==t.html_attrs.name&&t.html_attrs.name||(t.html_attrs.name="formula_data[]"),l.append('<span class="relationship-'+r.fields_relationship.toLowerCase()+' relationship">'+r.fields_relationship+"</span>"),vgseAddField(l,t)}),l.find(".select2")&&"function"==typeof vgseInitSelect2&&vgseInitSelect2(),l.find("input,textarea").each(function(){vgseInputToFormattedColumnField(n.val(),$field.parent(),".formula-parameter-field")});var i=l.find("input,select,textarea");i.change(function(e){var t=vgseExecuteFunctionByName(r.jsCallback,window,{changedField:jQuery(this),actionFields:i,actionSettings:r,firstField:i.first(),firstFieldValue:i.first().val()});t=t||"",_.val(t)}),i.first().trigger("change")}),jQuery("body").on("click",".wp-media.button",function(e){loading_ajax({estado:!0});var t=jQuery(this),o=t.parent().find("input"),a=t.data("multiple"),l=jQuery("body").scrollLeft(),s=[],r=jQuery(document).scrollTop(),i=jQuery("#infinito").prop("checked");jQuery("#infinito").prop("checked",!1),media_uploader=wp.media({frame:"post",state:"insert",multiple:a}),media_uploader.state("embed").on("select",function(){var e=media_uploader.state(),t=e.get("type"),a=e.props.toJSON();a.url=a.url||"","image"===t&&a.url&&(o.val(a.url).trigger("change"),o.after('<div class="selected-files"></div>'),o.next(".selected-files").append('<img src="'+a.url+'" width="80" height="80"/>'))}),media_uploader.on("close",function(){jQuery("body").scrollLeft(l),jQuery(window).scrollTop(r),jQuery("#infinito").prop("checked",i)}),media_uploader.on("insert",function(){jQuery("body").scrollLeft(l);var e=media_uploader.state().get("selection"),t=e.length,a=e.models;if(!a.length)return!0;o.after('<div class="selected-files"></div>');for(var r=0;r<t;r++)file=a[r].toJSON(),s.push(a[r].id),o.next(".selected-files").append('<img src="'+file.sizes.thumbnail.url+'" width="80" height="80"/>');o.val(s).trigger("change")}),media_uploader.open(),loading_ajax({estado:!1})})}),jQuery(document).ready(function(){jQuery(".vgse-simple-tabs").each(function(){var a=jQuery(this);a.find("a").first().trigger("click"),a.find("a").click(function(e){e.preventDefault();var t=jQuery(this).attr("href");a.find("a").removeClass("active"),jQuery(this).addClass("active"),jQuery(".vgse-simple-tab-content").removeClass("active"),jQuery(t).addClass("active")})})}),jQuery(document).ready(function(){jQuery("body").on("click",".save-formula",function(e){e.preventDefault(),loading_ajax({estado:!0});jQuery(this);var t=jQuery(".apply-to-future-posts-field input:checkbox");t.is(":checked")||t.prop("checked",!0);var a=jQuery("#vgse-create-formula").serializeArray();a.push({name:"action",value:"vgse_save_formula"}),jQuery.post(ajaxurl,a,function(e){e.success&&jQuery('[data-remodal-id="modal-formula"]').remodal().close();loading_ajax({estado:!1})})}),jQuery("body").on("click",".delete-saved-formula",function(e){e.preventDefault(),loading_ajax({estado:!0});var t=jQuery(this);jQuery.post(ajaxurl,{action:"vgse_delete_saved_formula",nonce:jQuery("#vgse-wrapper").data("nonce"),post_type:vgse_editor_settings.post_type,formula_index:t.data("formula-index")},function(e){e.success&&(t.parents("li").slideUp(),t.parents("li").remove()),loading_ajax({estado:!1})})})}),jQuery(document).ready(function(){jQuery("body").on("mousedown","th .bulk-selector",function(e){jQuery("th .bulk-selector").data("value-before-click",jQuery(this).prop("checked"))}),jQuery("body").on("click","th .bulk-selector",function(e){for(var t=jQuery(this),a=jQuery("th .bulk-selector"),r=!t.data("value-before-click"),o=hot.countRows(),l=0;l<o;l++)hot.setDataAtCell(l,0,r);jQuery("th .bulk-selector").prop("checked",r),a.data("value-before-click",r),r&&(jQuery('[data-remodal-id="modal-formula"]').remodal().open(),jQuery(".modal-formula .wpse-select-rows-options").val("current_search"))}),jQuery(document).on("opened",".modal-formula",function(){vgseGetSelectedIds().length&&!jQuery("th .bulk-selector").prop("checked")&&jQuery(".modal-formula .wpse-select-rows-options").val("selected")})});